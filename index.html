<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—å…§å°ˆå±¬å„ªæƒ åˆ¸</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'PingFang TC', sans-serif; text-align: center; padding: 40px 20px; background: #f8f9fa; }
        .container { background: white; padding: 40px 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); max-width: 400px; margin: 0 auto; }
        h2 { color: #333; margin-bottom: 10px; }
        p { color: #666; margin-bottom: 30px; line-height: 1.6; }
        .btn { border: none; padding: 18px 35px; border-radius: 50px; font-size: 1.3em; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        #get-btn { background: #ff4757; color: white; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        #verify-btn { background: #2ed573; color: white; box-shadow: 0 4px 15px rgba(46, 213, 115, 0.3); }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background: #ccc !important; box-shadow: none !important; }
        #loading-text { display: none; color: #ff4757; font-weight: bold; margin-top: 20px; }
        .code-display { font-size: 2.2em; color: #ff4757; font-weight: bold; margin: 20px 0; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <!-- é ˜å–ä»‹é¢ -->
        <div id="get-ui">
            <h2>âœ¨ ä»Šæ—¥é™å®šå„ªæƒ </h2>
            <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é ˜å–å°ˆå±¬å„ªæƒ åˆ¸<br>é ˜å–å¾Œå°‡ç™¼é€è‡³æ‚¨çš„èŠå¤©å®¤</p>
            <button id="get-btn" class="btn" onclick="handleGetCoupon()">ç«‹å³é ˜å–å„ªæƒ </button>
        </div>

        <!-- æ ¸éŠ·ä»‹é¢ (é è¨­éš±è—) -->
        <div id="verify-ui" style="display:none;">
            <h2>ğŸ« å„ªæƒ åˆ¸æ ¸éŠ·</h2>
            <div class="code-display" id="coupon-code">------</div>
            <p>çµå¸³æ™‚è«‹ç”±<strong>åº—å“¡é»æ“Š</strong>ä¸‹æ–¹æŒ‰éˆ•</p>
            <button id="verify-btn" class="btn" onclick="handleVerify()">ç¢ºèªæ ¸éŠ·å„ªæƒ åˆ¸</button>
        </div>

        <div id="loading-text">æ­£åœ¨è™•ç†ä¸­...</div>
    </div>

    <script>
        // ã€ä¿®æ­£ 1ã€‘ï¼šè«‹å‹™å¿…å¡«å…¥å®Œæ•´çš„ GAS ç¶²å€
        const API_URL = 'https://script.google.com/macros/s/AKfycbz3c2IdEfOj0qX4psE16pLMfptqHnwlppk8GWKj3-ZuZparWKlDeWZeDbdxL857S4ATcg/exec'; 
        const LIFF_ID = "2008952529-BCywLq7k";
        let userId = '';
        let currentCoupon = '';

        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                    checkUserStatus(); // åˆ¤æ–·æ˜¯è¦ã€Œé ˜åˆ¸ã€é‚„æ˜¯ã€Œæ ¸éŠ·ã€
                }
            } catch (err) {
                alert("è«‹åœ¨ LINE App å…§é–‹å•Ÿæ­¤é é¢");
            }
        }

        // åˆ¤æ–·ç‹€æ…‹ï¼šè‹¥å·²æœ‰æœªæ ¸éŠ·åºè™Ÿï¼Œç›´æ¥é¡¯ç¤ºæ ¸éŠ·ä»‹é¢
        async function checkUserStatus() {
            try {
                const res = await fetch(`${API_URL}?uid=${userId}`);
                const data = await res.json();
                if (data.code && data.status === "æœªæ ¸éŠ·") {
                    showVerifyUI(data.code);
                }
            } catch (e) { console.log("æ–°ç”¨æˆ¶æˆ–å·²æ ¸éŠ·"); }
        }

        function showVerifyUI(code) {
            currentCoupon = code;
            document.getElementById('get-ui').style.display = 'none';
            document.getElementById('verify-ui').style.display = 'block';
            document.getElementById('coupon-code').innerText = code;
        }

        // é ˜å–é‚è¼¯
        async function handleGetCoupon() {
            const btn = document.getElementById('get-btn');
            const loader = document.getElementById('loading-text');
            btn.disabled = true;
            loader.style.display = 'block';

            try {
                const res = await fetch(`${API_URL}?uid=${userId}`);
                const data = await res.json();
                if (data.error) { alert(data.error); return; }

                await sendFlexCoupon(data.code);
                alert("å„ªæƒ åˆ¸å·²ç™¼é€è‡³æ‚¨çš„èŠå¤©å®¤ï¼");
                liff.closeWindow();
            } catch (e) {
                alert("é ˜å–å¤±æ•—ï¼Œè«‹é‡è©¦");
                btn.disabled = false;
            }
        }

        // æ ¸éŠ·é‚è¼¯
        async function handleVerify() {
            if (confirm("ç¢ºèªç”±åº—å“¡æ ¸éŠ·æ­¤åˆ¸ï¼Ÿ")) {
                document.getElementById('verify-btn').disabled = true;
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ uid: userId }) });
                alert("æ ¸éŠ·å®Œæˆï¼æœŸå¾…ä¸‹æ¬¡å…‰è‡¨");
                if (liff.isInClient()) {
                    await liff.sendMessages([{ "type": "text", "text": "âœ… å„ªæƒ åˆ¸å·²æˆåŠŸæ ¸éŠ·ï¼\nåºè™Ÿï¼š" + currentCoupon }]);
                    liff.closeWindow();
                }
            }
        }

        async function sendFlexCoupon(code) {
            if (liff.isInClient()) {
                try {
                    await liff.sendMessages([{
                        "type": "flex",
                        "altText": "ğŸ æ‚¨çš„å°ˆå±¬å„ªæƒ åˆ¸å·²é€é”ï¼",
                        "contents": {
                            "type": "bubble",
                            "header": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": "LIMITED OFFER", "color": "#ffffff", "size": "xs", "weight": "bold" }], "backgroundColor": "#ff4757" },
                            "body": { "type": "box", "layout": "vertical", "contents": [
                                { "type": "text", "text": "åº—å…§å°ˆå±¬å„ªæƒ åˆ¸", "weight": "bold", "size": "xl" },
                                { "type": "text", "text": "åºè™Ÿï¼š" + code, "size": "md", "margin": "md", "weight": "bold" },
                                { "type": "text", "text": "çµå¸³æ™‚è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œæ ¸éŠ·", "size": "xxs", "color": "#aaaaaa", "margin": "md" }
                            ]},
                            "footer": { "type": "box", "layout": "vertical", "contents": [
                                { "type": "button", "action": { "type": "uri", "label": "ç«‹å³æ ¸éŠ· (åº—å“¡æ“ä½œ)", "uri": "https://liff.line.me" + LIFF_ID }, "style": "primary", "color": "#2ed573" }
                            ]}
                        }
                    }]);
                } catch (e) { alert("è«‹å…ˆæˆæ¬Šå‚³é€è¨Šæ¯æ¬Šé™"); }
            }
        }

        initLIFF();
    </script>
</body>
</html>
