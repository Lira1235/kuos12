<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—å…§å°ˆå±¬å„ªæƒ åˆ¸</title>
    <!-- ã€ä¿®æ­£ 1ã€‘ï¼šè£œå…¨å®Œæ•´çš„ LIFF SDK è·¯å¾‘ -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
     <style>
        body { font-family: 'PingFang TC', sans-serif; text-align: center; padding: 40px 20px; background: #f8f9fa; }
        .container { background: white; padding: 40px 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); max-width: 400px; margin: 0 auto; }
        h2 { color: #333; margin-bottom: 10px; }
        p { color: #666; margin-bottom: 30px; line-height: 1.6; }
        #get-btn { background: #ff4757; color: white; border: none; padding: 18px 35px; border-radius: 50px; font-size: 1.3em; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        #get-btn:active { transform: scale(0.95); background: #ff6b81; }
        #get-btn:disabled { background: #ccc; box-shadow: none; }
        #loading-text { display: none; color: #ff4757; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>âœ¨ ä»Šæ—¥é™å®šå„ªæƒ </h2>
        <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é ˜å–å°ˆå±¬å„ªæƒ åˆ¸<br>é ˜å–å¾Œå°‡ç™¼é€è‡³æ‚¨çš„èŠå¤©å®¤</p>
        
        <button id="get-btn" onclick="handleGetCoupon()">ç«‹å³é ˜å–å„ªæƒ </button>
        <div id="loading-text">æ­£åœ¨ç‚ºæ‚¨æº–å‚™å„ªæƒ åˆ¸...</div>
    </div>

    <script>
        const API_URL = 'https://script.google.com'; 
        const LIFF_ID = "2008952529-BCywLq7k";
        let userId = '';

        // åˆå§‹åŒ– LIFF
        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                }
            } catch (err) {
                alert("è«‹åœ¨ LINE App å…§é–‹å•Ÿæ­¤é é¢");
            }
        }

        // é»æ“Šã€Œé ˜å–å„ªæƒ ã€æŒ‰éˆ•
        async function handleGetCoupon() {
            const btn = document.getElementById('get-btn');
            const loader = document.getElementById('loading-text');

            btn.disabled = true;
            btn.style.display = 'none';
            loader.style.display = 'block';

            try {
                // 1. å‘ GAS ç²å–åºè™Ÿ (è‡ªå‹•å¾åºè™Ÿæ± æŠ“å–)
                const res = await fetch(`${API_URL}?uid=${userId}`);
                const data = await res.json();

                if (data.error) {
                    alert(data.error);
                    loader.innerText = data.error;
                    return;
                }

                const couponCode = data.code;

                // 2. æ–¼èŠå¤©å®¤å½ˆå‡º Flex Message
                await sendFlexCoupon(couponCode);

                // 3. ç™¼é€å®Œæˆå¾Œè‡ªå‹•é—œé–‰è¦–çª—
                setTimeout(() => {
                    liff.closeWindow();
                }, 500);

            } catch (e) {
                alert("é ˜å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                btn.disabled = false;
                btn.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        // ç™¼é€ Flex Message å‡½å¼
        async function sendFlexCoupon(code) {
            if (liff.isInClient()) {
                try {
                    await liff.sendMessages([{
                        "type": "flex",
                        "altText": "ğŸ æ‚¨çš„å°ˆå±¬å„ªæƒ åˆ¸å·²é€é”ï¼",
                        "contents": {
                            "type": "bubble",
                            "header": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": "LIMITED OFFER", "color": "#ffffff", "size": "xs", "weight": "bold" }], "backgroundColor": "#ff4757" },
                            "body": { "type": "box", "layout": "vertical", "contents": [
                                { "type": "text", "text": "åº—å…§å°ˆå±¬å„ªæƒ åˆ¸", "weight": "bold", "size": "xl" },
                                { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                                    { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [
                                        { "type": "text", "text": "åºè™Ÿ", "color": "#aaaaaa", "size": "sm", "flex": 1 },
                                        { "type": "text", "text": code, "wrap": true, "color": "#333333", "size": "md", "flex": 4, "weight": "bold" }
                                    ]}
                                ]},
                                { "type": "text", "text": "è«‹ä¿ç•™æ­¤è¨Šæ¯ï¼Œçµå¸³æ™‚é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ ¸éŠ·", "size": "xxs", "color": "#aaaaaa", "margin": "md" }
                            ]},
                            "footer": { "type": "box", "layout": "vertical", "contents": [
                                { "type": "button", "action": { "type": "uri", "label": "ç«‹å³æ ¸éŠ· (åº—å“¡é»æ“Š)", "uri": "https://liff.line.me" + LIFF_ID }, "style": "primary", "color": "#2ed573" }
                            ]}
                        }
                    }]);
                } catch (e) {
                    console.error("ç™¼é€å¤±æ•—ï¼Œè«‹ç¢ºèª Scopes æ¬Šé™å·²é–‹å•Ÿ");
                }
            }
        }

        initLIFF();
    </script>
</body>
</html>
