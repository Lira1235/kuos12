<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—å…§å°ˆå±¬å„ªæƒ åˆ¸</title>
    <!-- ã€ä¿®æ­£ 1ã€‘ï¼šè£œå…¨å®Œæ•´çš„ LIFF SDK è·¯å¾‘ -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; text-align: center; padding: 20px; background: #f8f9fa; color: #333; }
        .coupon-card { background: white; padding: 30px; border-radius: 20px; border: 3px dashed #ff4757; box-shadow: 0 8px 20px rgba(0,0,0,0.05); max-width: 400px; margin: 0 auto; }
        .code { font-size: 2.8em; color: #ff4757; font-weight: bold; margin: 20px 0; letter-spacing: 2px; font-family: monospace; }
        button { background: #2ed573; color: white; border: none; padding: 18px 35px; border-radius: 50px; font-size: 1.2em; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(46, 213, 115, 0.3); }
        button:disabled { background: #ccc; }
        #loading { padding: 50px 0; color: #666; }
    </style>
</head>
<body>
    <div class="coupon-card">
        <h2>å°ˆå±¬å„ªæƒ åºè™Ÿ</h2>
        <div id="loading">âœ¨ æ­£åœ¨ç²å–æ‚¨çš„å„ªæƒ ...</div>
        <div id="coupon-area" style="display:none;">
            <div class="code" id="coupon-code">------</div>
            <p>çµå¸³æ™‚è«‹ç”±<strong>åº—å“¡é»æ“Š</strong>ä¸‹æ–¹æŒ‰éˆ•</p>
            <button id="verify-btn" onclick="handleVerify()">ç¢ºèªæ ¸éŠ·å„ªæƒ åˆ¸</button>
        </div>
    </div>

    <script>
        // ç¢ºèª API_URL ç‚ºæœ€æ–°çš„ GAS éƒ¨ç½²ç¶²å€
        const API_URL = 'https://script.google.com/macros/s/AKfycbzFTWIeh_1bjhLjm1YWcWBr2_rX_qtq-JkaqR2KrABL68rPr7FJr62QlwTYN07nN-aGOg/exec'; 
        const LIFF_ID = "2008952529-BCywLq7k";
        let userId = '';
        let currentCoupon = '';

        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                    getCoupon();
                }
            } catch (err) { 
                document.getElementById('loading').innerText = "âŒ è«‹æ–¼ LINE å…§é–‹å•Ÿ";
                console.error(err);
            }
        }

        async function getCoupon() {
            try {
                const res = await fetch(`${API_URL}?uid=${userId}`);
                const data = await res.json();
                
                if (data.error) {
                    alert(data.error);
                    document.getElementById('loading').innerText = data.error;
                    return;
                }

                currentCoupon = data.code;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('coupon-area').style.display = 'block';
                document.getElementById('coupon-code').innerText = currentCoupon;

                // ç²å–å„ªæƒ åˆ¸å¾Œï¼Œè‡ªå‹•ç™¼é€å¡ç‰‡åˆ°èŠå¤©å®¤
                await sendCouponToChat(currentCoupon);
            } catch (e) {
                console.error(e);
                alert("ç²å–å¤±æ•—ï¼Œè«‹é‡è©¦");
            }
        }

        async function sendCouponToChat(code) {
            if (liff.isInClient()) {
                try {
                    await liff.sendMessages([{
                        "type": "flex",
                        "altText": "æ‚¨æœ‰ä¸€å¼µæ–°çš„å„ªæƒ åˆ¸ï¼",
                        "contents": {
                            "type": "bubble",
                            "body": {
                                "type": "box", "layout": "vertical", "contents": [
                                    { "type": "text", "text": "ğŸ é ˜å–æˆåŠŸ", "weight": "bold", "color": "#ff4757", "size": "sm" },
                                    { "type": "text", "text": "åº—å…§å°ˆå±¬å„ªæƒ åˆ¸", "weight": "bold", "size": "xl", "margin": "md" },
                                    { "type": "text", "text": "åºè™Ÿï¼š" + code, "size": "md", "margin": "sm", "weight": "bold" },
                                    { "type": "text", "text": "è«‹ä¿ç•™æ­¤è¨Šæ¯ï¼Œçµå¸³æ™‚å‡ºç¤ºã€‚", "size": "xs", "color": "#888888", "margin": "md" }
                                ]
                            },
                            "footer": {
                                "type": "box", "layout": "vertical", "contents": [
                                    { 
                                        "type": "button", 
                                        "action": { 
                                            "type": "uri", 
                                            "label": "é–‹å•Ÿæ ¸éŠ·é é¢", 
                                            // ã€ä¿®æ­£ 2ã€‘ï¼šè£œä¸Šæ–œç·š /
                                            "uri": "https://liff.line.me" + LIFF_ID 
                                        }, 
                                        "style": "primary", 
                                        "color": "#2ed573" 
                                    }
                                ]
                            }
                        }
                    }]);
                } catch (e) { console.log("è‡ªå‹•ç™¼é€å¤±æ•—ï¼Œå¯èƒ½æœªæˆæ¬Š"); }
            }
        }

        async function handleVerify() {
            if (confirm("ç¢ºèªç”±åº—å“¡æ ¸éŠ·æ­¤åˆ¸ï¼Ÿ")) {
                const btn = document.getElementById('verify-btn');
                btn.disabled = true;
                btn.innerText = "æ ¸éŠ·ä¸­...";
                
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        body: JSON.stringify({ uid: userId })
                    });
                    
                    alert("æ ¸éŠ·å®Œæˆï¼");
                    if (liff.isInClient()) {
                        await liff.sendMessages([{ "type": "text", "text": "âœ… å„ªæƒ åˆ¸å·²æ ¸éŠ·æˆåŠŸï¼\nåºè™Ÿï¼š" + currentCoupon }]);
                        liff.closeWindow();
                    }
                } catch (err) {
                    alert("æ ¸éŠ·å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                    btn.disabled = false;
                    btn.innerText = "ç¢ºèªæ ¸éŠ·å„ªæƒ åˆ¸";
                }
            }
        }

        initLIFF();
    </script>
</body>
</html>
